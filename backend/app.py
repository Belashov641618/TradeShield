from flask import Flask, request, jsonify
from flask_cors import CORS
import time
import random

app = Flask(__name__)
CORS(app)  # –†–∞–∑—Ä–µ—à–∞–µ–º CORS –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

# –ó–∞–≥–ª—É—à–∫–∏ –¥–∞–Ω–Ω—ã—Ö
PRODUCT_CODES = {
    "123": "123456789",
    "1234": "123456789",
    "12345": "123456789",
    "123456": "123456789",
    "1234567": "123456789",
    "12345678": "123456789",
    "123456789": "123456789",
    "234": "234567890",
    "2345": "234567890",
    "23456": "234567890",
    "234567": "234567890",
    "2345678": "234567890",
    "23456789": "234567890",
    "234567890": "234567890",
    "345": "345678901",
    "3456": "345678901",
    "34567": "345678901",
    "345678": "345678901",
    "3456789": "345678901",
    "34567890": "345678901",
    "345678901": "345678901"
}

PRODUCT_NAMES = {
    "123456789": [
        {"name": "–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞", "code": "123456789"},
        {"name": "–ü–æ–ª—É–ø—Ä–æ–≤–æ–¥–Ω–∏–∫–æ–≤—ã–µ –ø—Ä–∏–±–æ—Ä—ã", "code": "123456789"},
        {"name": "–ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—ã–µ –º–∏–∫—Ä–æ—Å—Ö–µ–º—ã", "code": "123456789"}
    ],
    "234567890": [
        {"name": "–ú–∞—à–∏–Ω—ã –∏ –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ", "code": "234567890"},
        {"name": "–î–≤–∏–≥–∞—Ç–µ–ª–∏ –∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã", "code": "234567890"},
        {"name": "–ù–∞—Å–æ—Å—ã –∏ –∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä—ã", "code": "234567890"}
    ],
    "345678901": [
        {"name": "–•–∏–º–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã", "code": "345678901"},
        {"name": "–û—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∏–º–∏—á–µ—Å–∫–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", "code": "345678901"},
        {"name": "–§–∞—Ä–º–∞—Ü–µ–≤—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã", "code": "345678901"}
    ]
}

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–¥–∞—á –∞–Ω–∞–ª–∏–∑–∞
analysis_jobs = {}

@app.route('/api/product-code/<query>', methods=['GET'])
def get_product_code(query):
    """GET –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫–æ–¥–∞ —Ç–æ–≤–∞—Ä–∞"""
    # –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏–ª–∏ –Ω–∞–∏–±–æ–ª–µ–µ –±–ª–∏–∑–∫–æ–µ
    if query in PRODUCT_CODES:
        return jsonify({
            "code": PRODUCT_CODES[query],
            "exists": True
        })
    
    # –ò—â–µ–º —á–∞—Å—Ç–∏—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
    suggestions = []
    for key, value in PRODUCT_CODES.items():
        if key.startswith(query):
            suggestions.append(value)
    
    if suggestions:
        return jsonify({
            "code": suggestions[0],  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π
            "exists": True
        })
    
    return jsonify({
        "code": None,
        "exists": False
    })

@app.route('/api/product-names/<product_code>', methods=['GET'])
def get_product_names(product_code):
    """GET –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–π —Ç–æ–≤–∞—Ä–∞ –ø–æ –∫–æ–¥—É"""
    if product_code in PRODUCT_NAMES:
        return jsonify({
            "names": PRODUCT_NAMES[product_code],
            "exists": True
        })
    
    return jsonify({
        "names": [],
        "exists": False
    })

@app.route('/api/analyze', methods=['POST'])
def start_analysis():
    """POST –∑–∞–ø—Ä–æ—Å –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞–Ω–∞–ª–∏–∑–∞"""
    data = request.get_json()
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –∑–∞–¥–∞—á–∏
    job_id = f"job_{int(time.time())}_{random.randint(1000, 9999)}"
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–¥–∞—á—É
    analysis_jobs[job_id] = {
        "status": "processing",
        "inn": data.get('inn'),
        "productCode": data.get('productCode'),
        "productName": data.get('productName'),
        "created_at": time.time()
    }
    
    return jsonify({
        "job": job_id,
        "message": "–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω"
    })

@app.route('/api/job/<job_id>', methods=['GET'])
def get_job_status(job_id):
    """GET –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏"""
    if job_id not in analysis_jobs:
        return jsonify({"error": "–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"}), 404
    
    job = analysis_jobs[job_id]
    elapsed_time = time.time() - job["created_at"]
    
    # –ò–º–∏—Ç–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞
    if elapsed_time < 5:
        progress = int(elapsed_time * 20)
        return jsonify({
            "status": f"–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö... {progress}%",
            "progress": progress
        })
    elif elapsed_time < 10:
        progress = int((elapsed_time - 5) * 20)
        return jsonify({
            "status": f"–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤... {progress}%",
            "progress": progress
        })
    else:
        # –ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        actions = {
            "regulations": [
                {
                    "id": "wto_tariff",
                    "title": "–ü–æ–≤—ã—à–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏ —Ç–∞–º–æ–∂–µ–Ω–Ω–æ–π –ø–æ—à–ª–∏–Ω—ã –¥–æ —É—Ä–æ–≤–Ω—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è –≤ —Ä–∞–º–∫–∞—Ö –í—Å–µ–º–∏—Ä–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–í–¢–û)",
                    "description": "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–≤—ã—à–µ–Ω–∏–µ –ø–æ—à–ª–∏–Ω—ã –¥–æ 15% –≤ —Ä–∞–º–∫–∞—Ö –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤ –í–¢–û",
                    "priority": "high",
                    "applicable": True
                },
                {
                    "id": "national_tariff",
                    "title": "–ü–æ–≤—ã—à–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏ —Ç–∞–º–æ–∂–µ–Ω–Ω–æ–π –ø–æ—à–ª–∏–Ω—ã –¥–æ —É—Ä–æ–≤–Ω—è 35‚Äì50 % –≤ —Ä–∞–º–∫–∞—Ö –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä—Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è",
                    "description": "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ–≤—ã—à–µ–Ω–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫ –≤ —Ä–∞–º–∫–∞—Ö –∫–æ–Ω—Ç—Ä—Å–∞–Ω–∫—Ü–∏–æ–Ω–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–∏",
                    "priority": "medium",
                    "applicable": True
                },
                {
                    "id": "anti_dumping",
                    "title": "–ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω—Ç–∏–¥–µ–º–ø–∏–Ω–≥–æ–≤–æ–≥–æ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç—ë—Ä–æ–≤ –∏–∑ —Å—Ç—Ä–∞–Ω(—ã) X",
                    "description": "–†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–µ–º–ø–∏–Ω–≥–æ–≤—ã—Ö —Ü–µ–Ω –Ω–∞ —Ç–æ–≤–∞—Ä—ã –∏–∑ –ö–∏—Ç–∞—è –∏ –ì–µ—Ä–º–∞–Ω–∏–∏",
                    "priority": "high",
                    "applicable": True
                },
                {
                    "id": "certification",
                    "title": "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∫ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º–æ–º—É —Ç–æ–≤–∞—Ä—É",
                    "description": "–í–≤–µ–¥–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞",
                    "priority": "medium",
                    "applicable": True
                },
                {
                    "id": "preferential",
                    "title": "–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–ª–∏ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–µ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ –≤ —Ä–∞–º–∫–∞—Ö –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–∫—É–ø–æ–∫",
                    "description": "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ –≥–æ—Å–∑–∞–∫—É–ø–∫–∏",
                    "priority": "low",
                    "applicable": False
                },
                {
                    "id": "other_measures",
                    "title": "–ò–Ω—ã–µ –º–µ—Ä—ã –∑–∞—â–∏—Ç—ã —Ä—ã–Ω–∫–∞ (–∑–∞–ø—Ä–µ—Ç –∏–ª–∏ –∫–≤–æ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∞, –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π —Å–±–æ—Ä, –Ω–µ–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ)",
                    "description": "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ä—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏",
                    "priority": "low",
                    "applicable": False
                }
            ],
            "companies": [
                {
                    "inn": "1234567890",
                    "name": "–û–û–û '–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã'",
                    "region": "–ú–æ—Å–∫–≤–∞",
                    "volume": "150 –º–ª–Ω —Ä—É–±"
                },
                {
                    "inn": "2345678901", 
                    "name": "–ê–û '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –±—É–¥—É—â–µ–≥–æ'",
                    "region": "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
                    "volume": "89 –º–ª–Ω —Ä—É–±"
                },
                {
                    "inn": "3456789012",
                    "name": "–ü–ê–û '–ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è'",
                    "region": "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫", 
                    "volume": "67 –º–ª–Ω —Ä—É–±"
                },
                {
                    "inn": "4567890123",
                    "name": "–û–û–û '–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏'",
                    "region": "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥",
                    "volume": "45 –º–ª–Ω —Ä—É–±"
                },
                {
                    "inn": "5678901234",
                    "name": "–ê–û '–ù–∞—É—á–Ω–æ-–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å'",
                    "region": "–ö–∞–∑–∞–Ω—å",
                    "volume": "32 –º–ª–Ω —Ä—É–±"
                }
            ],
            "statistics": {
                "import_volume": "2.5 –º–ª—Ä–¥ —Ä—É–±",
                "growth_rate": "+12%",
                "main_suppliers": ["–ö–∏—Ç–∞–π", "–ì–µ—Ä–º–∞–Ω–∏—è", "–Ø–ø–æ–Ω–∏—è"],
                "domestic_companies": 5,
                "total_domestic_volume": "383 –º–ª–Ω —Ä—É–±"
            }
        }
        
        # –£–¥–∞–ª—è–µ–º –∑–∞–¥–∞—á—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        del analysis_jobs[job_id]
        
        return jsonify({
            "actions": actions,
            "status": "completed"
        })

@app.route('/api/health', methods=['GET'])
def health_check():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ API"""
    return jsonify({
        "status": "ok",
        "message": "TradeShield API —Ä–∞–±–æ—Ç–∞–µ—Ç"
    })

if __name__ == '__main__':
    print("üöÄ –ó–∞–ø—É—Å–∫ TradeShield Backend API...")
    print("üì° –î–æ—Å—Ç—É–ø–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:")
    print("  GET  /api/product-code/<query>     - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫–æ–¥–∞ —Ç–æ–≤–∞—Ä–∞")
    print("  GET  /api/product-names/<code>     - –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–π –ø–æ –∫–æ–¥—É")
    print("  POST /api/analyze                  - –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞")
    print("  GET  /api/job/<job_id>             - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏")
    print("  GET  /api/health                   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏")
    print("\nüåê API –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:5000")
    
    app.run(debug=True, host='0.0.0.0', port=5000)
